# xcapture CSV Schema Documentation

This document defines the schema for all CSV files generated by xcapture when using the `-o DIR` output mode.

## Overview

xcapture generates multiple CSV file types, each with a specific purpose:
- **xcapture_samples_*.csv** - Task sampling data (main output)
- **xcapture_syscend_*.csv** - System call completion events
- **xcapture_iorqend_*.csv** - I/O request completion events  
- **xcapture_kstacks_*.csv** - Deduplicated kernel stack traces
- **xcapture_ustacks_*.csv** - Deduplicated userspace stack traces

Files are rotated hourly with timestamps in the filename format: `xcapture_TYPE_YYYYMMDD_HH0000.csv`

## Common Data Types

- **timestamp**: ISO 8601 format with microseconds (YYYY-MM-DDTHH:MM:SS.ffffff)
- **integer**: 64-bit signed or unsigned integer
- **string**: UTF-8 encoded text, may be truncated if exceeding field limits
- **json**: JSON-encoded object as string (for EXTRA_INFO field)
- **hex**: Hexadecimal string representation (for hashes and addresses)

## xcapture_samples CSV Schema

Main task sampling output with comprehensive system state information.

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| TIMESTAMP | timestamp | Sample collection time | 2025-08-28T00:26:58.651965 |
| WEIGHT_US | integer | Sample weight in microseconds (1/frequency) | 100000 |
| OFF_US | integer | Offset from sampling start in microseconds | 827 |
| TID | integer | Thread ID (task ID) | 32011 |
| TGID | integer | Thread Group ID (process ID) | 32011 |
| STATE | string | Task state (RUN, RUNQ, SLEEP, STOPPED, etc.) | RUNQ |
| USERNAME | string | Username or UID if name unavailable | root |
| EXE | string | Executable path or [kernel] for kernel threads | /usr/bin/sshd |
| COMM | string | Task command name (16 chars max) | sshd |
| SYSCALL | string | Current syscall name or "-" if none | poll |
| SYSCALL_ACTIVE | string | Active syscall name (same as SYSCALL if active) | poll |
| SYSC_US_SO_FAR | integer | Syscall duration so far in microseconds | 1250 |
| SYSC_ARG1 | hex/integer | First syscall argument (context-dependent) | 0x7fff1234 |
| FILENAME | string | File/resource name or "-" if none | /etc/passwd |
| SYSC_ENTRY_TIME | timestamp | Syscall entry timestamp | 2025-08-28T00:26:58.483170 |
| SYSC_SEQ_NUM | integer | Syscall sequence number for tracking | 12345 |
| IORQ_SEQ_NUM | integer | I/O request sequence number | 67890 |
| CONNECTION | string | Network connection info (protocol + endpoints) | TCP 192.168.1.1:22->10.0.0.1:54321 |
| CONN_STATE | string | Connection state (ESTABLISHED, LISTEN, etc.) | ESTABLISHED |
| EXTRA_INFO | json | Additional context as JSON object | {"tcp":{"cwnd":10,...}} |
| KSTACK_HASH | hex | Kernel stack trace hash (16 hex digits) | a1b2c3d4e5f67890 |
| USTACK_HASH | hex | Userspace stack trace hash (16 hex digits) | 1234567890abcdef |

### STATE Values
- **RUN**: Task is running on CPU
- **RUNQ**: Task is runnable, waiting for CPU
- **SLEEP**: Task is sleeping (interruptible)
- **DISK_SLEEP**: Task is in uninterruptible disk sleep
- **STOPPED**: Task is stopped (SIGSTOP/SIGTSTP)
- **ZOMBIE**: Task is a zombie (terminated but not reaped)
- **DEAD**: Task is dead
- **IDLE**: Task is an idle kernel thread

### CONNECTION Format
Format: `PROTOCOL [LOCAL_ADDR:PORT->REMOTE_ADDR:PORT]`
- TCP connections: `TCP 192.168.1.1:22->10.0.0.1:54321`
- UDP sockets: `UDP 0.0.0.0:53`
- Unix sockets: `UNIX-STREAM` or `UNIX-DGRAM`
- Raw sockets: `RAW`

### CONN_STATE Values (TCP)
- **ESTABLISHED**: Connection established
- **SYN_SENT**: Sent SYN, awaiting response
- **SYN_RECV**: Received SYN, sent SYN-ACK
- **FIN_WAIT1**: Sent FIN, awaiting ACK
- **FIN_WAIT2**: Received ACK of FIN, awaiting FIN
- **TIME_WAIT**: Waiting for network to clear segments
- **CLOSE**: Connection closed
- **CLOSE_WAIT**: Received FIN, awaiting close from app
- **LAST_ACK**: Sent FIN after receiving FIN
- **LISTEN**: Listening for connections
- **CLOSING**: Both sides initiated close simultaneously

### EXTRA_INFO JSON Structure

The EXTRA_INFO field contains a JSON object with optional nested objects:

#### TCP Statistics (when sampling TCP sockets)
```json
{
  "tcp": {
    "cwnd": 10,              // Congestion window (packets)
    "ssthresh": 50,          // Slow start threshold
    "ca_state": 0,           // Congestion avoidance state (0=Open, 1=Disorder, 2=CWR, 3=Recovery, 4=Loss)
    "srtt_us": 3201,         // Smoothed RTT in microseconds
    "mdev_us": 360,          // RTT mean deviation
    "rtt_min": 2500,         // Minimum RTT observed
    "rcv_wnd": 60032,        // Receive window size
    "snd_wnd": 259968,       // Send window size
    "packets_out": 5,        // Packets in flight
    "retrans_out": 1,        // Retransmitted packets out
    "total_retrans": 3,      // Total retransmissions
    "lost_out": 0,           // Lost packets
    "sacked_out": 2,         // SACKed packets
    "reordering": 3,         // Reordering metric
    "bytes_in_flight": 7300, // Bytes currently in flight
    "bytes_unread": 1024,    // Bytes in receive queue
    "delivered": 1940,       // Packets delivered
    "delivered_ce": 0        // Packets delivered with CE mark
  }
}
```

#### Other EXTRA_INFO fields (future extensions)
- io_uring state information
- epoll/poll file descriptor details  
- Memory-mapped file information
- Process namespace details

## xcapture_syscend CSV Schema

System call completion events for tracked syscalls.

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| TIMESTAMP | timestamp | Syscall completion time | 2025-08-28T00:27:00.123456 |
| TID | integer | Thread ID | 1234 |
| COMM | string | Task command name | nginx |
| SYSCALL | string | System call name | read |
| DURATION_NS | integer | Syscall duration in nanoseconds | 150000 |
| RETVAL | integer | System call return value | 1024 |
| ERRNO | integer | Error number (0 if success) | 0 |
| ENTRY_TIME | timestamp | Syscall entry timestamp | 2025-08-28T00:27:00.123306 |
| EXIT_TIME | timestamp | Syscall exit timestamp | 2025-08-28T00:27:00.123456 |

## xcapture_iorqend CSV Schema  

Block I/O request completion events.

- In classic mode, rows are prefixed with `IORQ_END`.
- In ioqueue mode, rows are prefixed with `IOQQ_END`.

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| TIMESTAMP | timestamp | I/O completion time | 2025-08-28T00:27:00.234567 |
| TID | integer | Thread ID that initiated I/O | 5678 |
| COMM | string | Task command name | postgres |
| DEV | string | Block device (major:minor) | 8:0 |
| SECTOR | integer | Starting sector number | 204800 |
| SIZE | integer | I/O size in bytes | 4096 |
| OP | string | Operation type (READ/WRITE/FLUSH/DISCARD) | READ |
| FLAGS | hex | I/O flags bitmap | 0x1001 |
| QUEUE_TIME_NS | integer | Time spent in queue (nanoseconds) | 50000 |
| SERVICE_TIME_NS | integer | Device service time (nanoseconds) | 100000 |
| TOTAL_TIME_NS | integer | Total I/O time (nanoseconds) | 150000 |

## xcapture_kstacks CSV Schema

Deduplicated kernel stack traces (when using -k option).

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| HASH | hex | Stack trace hash (16 hex digits) | a1b2c3d4e5f67890 |
| STACK | string | Symbolized stack trace (semicolon-separated) | schedule;io_schedule;wait_on_page_bit |
| RAW_ADDRESSES | string | Raw addresses if symbols unavailable | 0xffffffff81234567;0xffffffff81234890 |
| COUNT | integer | Number of times this stack was seen | 42 |
| FIRST_SEEN | timestamp | First occurrence timestamp | 2025-08-28T00:27:00.000000 |
| LAST_SEEN | timestamp | Most recent occurrence timestamp | 2025-08-28T00:27:59.999999 |

## xcapture_ustacks CSV Schema

Deduplicated userspace stack traces (when using -u option).

| Column | Type | Description | Example |
|--------|------|-------------|---------|
| HASH | hex | Stack trace hash (16 hex digits) | 1234567890abcdef |
| STACK | string | Symbolized stack trace (semicolon-separated) | main;process_request;do_work |
| RAW_ADDRESSES | string | Raw addresses if symbols unavailable | 0x7fff12345678;0x7fff12345890 |
| BINARY | string | Binary/library containing the stack | /usr/bin/myapp |
| COUNT | integer | Number of times this stack was seen | 15 |
| FIRST_SEEN | timestamp | First occurrence timestamp | 2025-08-28T00:27:00.000000 |
| LAST_SEEN | timestamp | Most recent occurrence timestamp | 2025-08-28T00:27:59.999999 |

## Field Size Limits

- **COMM**: 16 characters (kernel limit)
- **FILENAME**: 256 characters  
- **EXE**: 256 characters
- **CONNECTION**: 128 characters
- **EXTRA_INFO**: 4096 characters (JSON string)
- **STACK**: 8192 characters (symbolized stack trace)

## Special Values

- **"-"**: Field not applicable or data not available
- **-1**: Numeric field not available or error
- **0**: May indicate unset, zero value, or beginning of range
- **"[kernel]"**: Kernel thread (no userspace executable)
- **"?"**: Value could not be determined

## Timestamp Precision

All timestamps use microsecond precision (6 decimal places) and are in the system's local timezone. The format follows ISO 8601: `YYYY-MM-DDTHH:MM:SS.ffffff`

## Notes for Tool Developers

1. **CSV Parsing**: Fields may contain commas within quoted strings. Use proper CSV parsing libraries.

2. **JSON Handling**: The EXTRA_INFO field contains JSON that must be parsed separately. Handle missing keys gracefully.

3. **Hash Correlation**: Use KSTACK_HASH and USTACK_HASH to join with stack trace CSV files for full stack information.

4. **Sequence Numbers**: SYSC_SEQ_NUM and IORQ_SEQ_NUM can be used to correlate samples with completion events.

5. **File Rotation**: New CSV files are created hourly. Tools should handle multiple files when analyzing time ranges.

6. **Missing Data**: Not all fields are populated for every sample. Kernel threads won't have userspace data, sleeping tasks may not have syscall info, etc.

7. **TCP Stats Availability**: TCP statistics in EXTRA_INFO are only present when sampling TCP sockets. The presence of the "tcp" key should be checked before accessing.

8. **Performance Considerations**: 
   - Sample files can be large (millions of rows per hour at high frequency)
   - Consider using streaming/incremental processing for large datasets
   - Hash fields enable deduplication of stack traces

## Example CSV Output

### xcapture_samples_20250828_000000.csv
```csv
TIMESTAMP,WEIGHT_US,OFF_US,TID,TGID,STATE,USERNAME,EXE,COMM,SYSCALL,SYSCALL_ACTIVE,SYSC_US_SO_FAR,SYSC_ARG1,FILENAME,SYSC_ENTRY_TIME,SYSC_SEQ_NUM,IORQ_SEQ_NUM,CONNECTION,CONN_STATE,EXTRA_INFO,KSTACK_HASH,USTACK_HASH
2025-08-28T00:27:18.482582,100000,588,1376,1376,SLEEP,nvidia-persistenced,/usr/bin/nvidia-persistenced,nvidia-persiste,poll,poll,0,0x10ea4dc0,-,2025-08-28T00:27:18.483170,0,0,-,-,-,a1b2c3d4e5f67890,1234567890abcdef
2025-08-28T00:27:18.482582,100000,1118,9764,9764,SLEEP,tanel,/usr/sbin/sshd,sshd,ppoll,ppoll,0,4,TCP,2025-08-28T00:27:18.483700,0,0,"TCP 192.168.0.53:22->192.168.0.156:52030",ESTABLISHED,"{""tcp"":{""cwnd"":10,""ssthresh"":50,""srtt_us"":3201}}",b2c3d4e5f6789012,2345678901bcdef0
```

### xcapture_syscend_20250828_000000.csv
```csv
TIMESTAMP,TID,COMM,SYSCALL,DURATION_NS,RETVAL,ERRNO,ENTRY_TIME,EXIT_TIME
2025-08-28T00:27:00.123456,1234,nginx,read,150000,1024,0,2025-08-28T00:27:00.123306,2025-08-28T00:27:00.123456
2025-08-28T00:27:00.124567,1234,nginx,write,75000,512,0,2025-08-28T00:27:00.124492,2025-08-28T00:27:00.124567
```
